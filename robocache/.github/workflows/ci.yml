name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  lint:
    name: Code Style & Linting
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install black flake8 mypy

    - name: Check code formatting with Black
      run: |
        black --check python/ tests/ examples/ || (echo "Run 'black python/ tests/ examples/' to fix formatting" && exit 1)

    - name: Lint with flake8
      run: |
        flake8 python/ tests/ examples/ --count --select=E9,F63,F7,F82 --show-source --statistics
        flake8 python/ tests/ examples/ --count --max-complexity=15 --max-line-length=100 --statistics

    - name: Type check with mypy
      run: |
        mypy python/robocache --ignore-missing-imports || true

  test-installation:
    name: Test Installation (CPU)
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.8', '3.9', '3.10', '3.11']

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install torch --index-url https://download.pytorch.org/whl/cpu
        pip install pytest pytest-cov

    - name: Install RoboCache (Python only)
      run: |
        pip install -e .

    - name: Run installation tests
      run: |
        pytest tests/test_installation.py -v -m "not gpu"

  build-docs:
    name: Build Documentation
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Check Markdown links
      uses: gaurav-nelson/github-action-markdown-link-check@v1
      with:
        use-quiet-mode: 'yes'
        config-file: '.github/markdown-link-check-config.json'
      continue-on-error: true

    - name: Validate documentation structure
      run: |
        echo "Checking documentation files exist..."
        test -f README.md || (echo "README.md missing" && exit 1)
        test -f CONTRIBUTING.md || (echo "CONTRIBUTING.md missing" && exit 1)
        test -f CODE_OF_CONDUCT.md || (echo "CODE_OF_CONDUCT.md missing" && exit 1)
        test -f LICENSE || (echo "LICENSE missing" && exit 1)
        test -f docs/build_instructions.md || (echo "docs/build_instructions.md missing" && exit 1)
        test -f docs/h100_optimizations.md || (echo "docs/h100_optimizations.md missing" && exit 1)
        echo "All required documentation files present!"

  check-cuda-syntax:
    name: Check CUDA Syntax
    runs-on: ubuntu-latest
    container:
      image: nvidia/cuda:12.3.0-devel-ubuntu22.04

    steps:
    - uses: actions/checkout@v4

    - name: Check CUDA syntax
      run: |
        nvcc --version
        # Syntax check only (no actual compilation without CUTLASS)
        for file in $(find kernels -name "*.cu"); do
          echo "Checking syntax: $file"
          nvcc -std=c++17 -arch=sm_80 --dryrun $file 2>&1 | grep -v "warning" || true
        done

  build-matrix:
    name: Build Test (No GPU)
    runs-on: ubuntu-latest
    strategy:
      matrix:
        cuda-version: ['12.1', '12.3']
      fail-fast: false

    steps:
    - uses: actions/checkout@v4

    - name: Setup Build Info
      run: |
        echo "Testing build configuration for CUDA ${{ matrix.cuda-version }}"
        echo "Note: This is a build test only. GPU tests require self-hosted runners with CUDA GPUs."

    - name: Check CMake configuration
      run: |
        if [ -f CMakeLists.txt ]; then
          echo "CMakeLists.txt found"
          grep "CMAKE_CUDA_STANDARD" CMakeLists.txt || echo "CUDA standard not set"
          grep "CMAKE_CXX_STANDARD" CMakeLists.txt || echo "CXX standard not set"
        fi

  # Note: GPU tests require self-hosted runners with CUDA GPUs
  # Uncomment and configure when self-hosted GPU runners are available
  #
  # test-gpu:
  #   name: GPU Tests
  #   runs-on: [self-hosted, gpu, cuda]
  #
  #   steps:
  #   - uses: actions/checkout@v4
  #
  #   - name: Setup CUDA
  #     run: |
  #       nvcc --version
  #       nvidia-smi
  #
  #   - name: Install CUTLASS 4.3.0
  #     run: |
  #       git clone https://github.com/NVIDIA/cutlass.git /tmp/cutlass
  #       cd /tmp/cutlass
  #       git checkout v4.3.0
  #       sudo cp -r include/cutlass /usr/local/include/
  #
  #   - name: Build RoboCache
  #     run: |
  #       mkdir build && cd build
  #       cmake .. -DCMAKE_BUILD_TYPE=Release
  #       make -j$(nproc)
  #
  #   - name: Install Python package
  #     run: |
  #       pip install -e ".[dev]"
  #
  #   - name: Run GPU tests
  #     run: |
  #       pytest tests/ -m gpu -v
  #
  #   - name: Run benchmarks
  #     run: |
  #       cd build
  #       ./benchmark_trajectory_resample

  status-check:
    name: CI Status Check
    runs-on: ubuntu-latest
    needs: [lint, test-installation, build-docs, check-cuda-syntax, build-matrix]
    if: always()

    steps:
    - name: Check CI results
      run: |
        if [ "${{ needs.lint.result }}" != "success" ] || \
           [ "${{ needs.test-installation.result }}" != "success" ] || \
           [ "${{ needs.build-docs.result }}" != "success" ] || \
           [ "${{ needs.check-cuda-syntax.result }}" != "success" ] || \
           [ "${{ needs.build-matrix.result }}" != "success" ]; then
          echo "One or more CI jobs failed"
          exit 1
        fi
        echo "All CI checks passed!"

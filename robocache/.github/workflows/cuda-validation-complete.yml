name: CUDA Validation Complete

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  schedule:
    - cron: '0 2 * * *'  # Nightly at 2 AM UTC

jobs:
  build-and-test-single-gpu:
    name: Build + Test (Single GPU)
    runs-on: [self-hosted, gpu, linux]
    strategy:
      matrix:
        python-version: ['3.10', '3.11']
        cuda-version: ['12.1']
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip setuptools wheel
          pip install torch==2.5.0+cu121 --index-url https://download.pytorch.org/whl/cu121
          pip install pytest pytest-benchmark psutil
      
      - name: Build CUDA extension
        run: |
          python setup.py build_ext --inplace
        env:
          CUDA_HOME: /usr/local/cuda-${{ matrix.cuda-version }}
      
      - name: Run self-test
        run: |
          python -c "import robocache; robocache.self_test()"
      
      - name: Run correctness tests
        run: |
          pytest tests/test_cuda_correctness.py -v --tb=short
      
      - name: Run performance tests
        run: |
          pytest tests/perf/ -v --tb=short
        env:
          PERF_GUARD_ENFORCE: "1"
      
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ matrix.python-version }}-cuda${{ matrix.cuda-version }}
          path: |
            test-results.xml
            bench/results/*.json

  multi-gpu-test:
    name: Multi-GPU Test
    runs-on: [self-hosted, gpu-multi, linux]
    if: github.event_name == 'schedule' || contains(github.event.head_commit.message, '[multi-gpu]')
    needs: build-and-test-single-gpu
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Install dependencies
        run: |
          pip install torch==2.5.0+cu121 --index-url https://download.pytorch.org/whl/cu121
          pip install pytest psutil
      
      - name: Build CUDA extension
        run: |
          python setup.py build_ext --inplace
      
      - name: Run multi-GPU tests
        run: |
          pytest tests/test_multi_gpu.py -v -s --tb=short
      
      - name: Upload multi-GPU results
        uses: actions/upload-artifact@v4
        with:
          name: multi-gpu-results
          path: test-results/

  soak-test:
    name: 8-Hour Soak Test
    runs-on: [self-hosted, gpu, linux]
    if: github.event_name == 'schedule'
    needs: build-and-test-single-gpu
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Install dependencies
        run: |
          pip install torch==2.5.0+cu121 --index-url https://download.pytorch.org/whl/cu121
          pip install pytest psutil numpy
      
      - name: Build CUDA extension
        run: |
          python setup.py build_ext --inplace
      
      - name: Run 8-hour soak test
        run: |
          pytest tests/test_soak.py::test_8hour_soak -v -s --tb=short
        timeout-minutes: 500
      
      - name: Upload soak test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: soak-test-results
          path: |
            soak-test-report.txt
            memory-samples.csv

  profiling:
    name: Nsight Profiling
    runs-on: [self-hosted, gpu, linux]
    if: github.event_name == 'schedule' || contains(github.event.head_commit.message, '[profile]')
    needs: build-and-test-single-gpu
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Install dependencies
        run: |
          pip install torch==2.5.0+cu121 --index-url https://download.pytorch.org/whl/cu121
      
      - name: Build CUDA extension
        run: |
          python setup.py build_ext --inplace
      
      - name: Run Nsight profiling
        run: |
          bash tools/profile_expert.sh trajectory_h100
      
      - name: Generate report
        run: |
          LATEST_DIR=$(ls -td artifacts/profiling/trajectory_h100_* | head -1)
          python scripts/generate_profiling_report.py "$LATEST_DIR" artifacts/PROFILING_REPORT.md
      
      - name: Upload profiling artifacts
        uses: actions/upload-artifact@v4
        with:
          name: nsight-profiling
          path: |
            artifacts/profiling/
            artifacts/PROFILING_REPORT.md

  benchmark:
    name: Benchmark Harness
    runs-on: [self-hosted, gpu, linux]
    needs: build-and-test-single-gpu
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Install dependencies
        run: |
          pip install torch==2.5.0+cu121 --index-url https://download.pytorch.org/whl/cu121
          pip install numpy pandas matplotlib
      
      - name: Build CUDA extension
        run: |
          python setup.py build_ext --inplace
      
      - name: Run benchmark harness
        run: |
          cd bench
          python benchmark_harness.py --seeds 5 --repeats 50
      
      - name: Check for regressions
        run: |
          python scripts/compare_baseline.py bench/results/*.csv
        continue-on-error: true
      
      - name: Upload benchmark results
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-results
          path: |
            bench/results/*.csv
            bench/results/*.html

  report:
    name: Generate Summary Report
    runs-on: ubuntu-latest
    needs: [build-and-test-single-gpu, benchmark]
    if: always()
    
    steps:
      - uses: actions/download-artifact@v4
        with:
          path: artifacts/
      
      - name: Generate summary
        run: |
          echo "# RoboCache CI/CD Summary" > SUMMARY.md
          echo "" >> SUMMARY.md
          echo "**Date:** $(date)" >> SUMMARY.md
          echo "**Commit:** ${{ github.sha }}" >> SUMMARY.md
          echo "" >> SUMMARY.md
          echo "## Test Results" >> SUMMARY.md
          find artifacts/ -name "*.json" -o -name "*.csv" | head -20 >> SUMMARY.md
      
      - name: Upload summary
        uses: actions/upload-artifact@v4
        with:
          name: ci-summary
          path: SUMMARY.md


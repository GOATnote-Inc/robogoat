name: Nightly Build

on:
  schedule:
    # Run at 2 AM UTC every day
    - cron: '0 2 * * *'
  workflow_dispatch:

jobs:
  nightly-tests:
    name: Nightly Test Suite
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install torch --index-url https://download.pytorch.org/whl/cpu
        pip install pytest pytest-cov

    - name: Install RoboCache
      run: |
        pip install -e ".[dev]"

    - name: Run all CPU tests
      run: |
        pytest tests/ -v -m "not gpu" --cov=robocache --cov-report=xml

    - name: Upload coverage
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage.xml
        flags: unittests
        name: robocache-coverage
      continue-on-error: true

  check-dependencies:
    name: Check Dependency Updates
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Check PyTorch version
      run: |
        pip install torch --index-url https://download.pytorch.org/whl/cpu
        python -c "import torch; print(f'PyTorch version: {torch.__version__}')"

    - name: Check CUDA availability
      run: |
        echo "Checking latest CUDA versions..."
        curl -s https://developer.nvidia.com/cuda-downloads | grep -o "cuda_[0-9.]*" | head -5 || true

  documentation-check:
    name: Documentation Health Check
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Check for broken links
      uses: gaurav-nelson/github-action-markdown-link-check@v1
      with:
        use-quiet-mode: 'no'
      continue-on-error: true

    - name: Check documentation completeness
      run: |
        echo "Checking for TODO items in documentation..."
        grep -r "TODO" docs/ README.md CONTRIBUTING.md || echo "No TODOs found"

        echo "Checking for placeholder text..."
        grep -r "PLACEHOLDER" docs/ README.md CONTRIBUTING.md || echo "No placeholders found"

  notify-nightly:
    name: Nightly Build Summary
    runs-on: ubuntu-latest
    needs: [nightly-tests, check-dependencies, documentation-check]
    if: always()

    steps:
    - name: Build summary
      run: |
        echo "Nightly build completed at $(date)"
        echo "Tests: ${{ needs.nightly-tests.result }}"
        echo "Dependencies: ${{ needs.check-dependencies.result }}"
        echo "Documentation: ${{ needs.documentation-check.result }}"
